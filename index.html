<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KCH Monitor</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

:root {
  --ink: #0d1117;
  --ink2: #161b26;
  --ink3: #1e2535;
  --ink4: #252f42;
  --line: rgba(255,255,255,0.06);
  --line2: rgba(255,255,255,0.1);
  --fog: #7e8fa8;
  --mist: #4a5568;
  --snow: #e8edf5;
  --teal: #00d4aa;
  --teal2: rgba(0,212,170,0.15);
  --amber: #f59e0b;
  --amber2: rgba(245,158,11,0.15);
  --rose: #f43f5e;
  --rose2: rgba(244,63,94,0.15);
  --sky: #38bdf8;
  --sky2: rgba(56,189,248,0.15);
  --violet: #a78bfa;
  --r: 14px;
  --rs: 10px;
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}

body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:var(--ink);
  color:var(--snow);
  max-width:430px;
  margin:0 auto;
  min-height:100vh;
  overflow-x:hidden;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  position:sticky;top:0;z-index:200;
  background:rgba(13,17,23,0.88);
  backdrop-filter:blur(24px);
  padding:12px 18px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;
}
.tb-brand{display:flex;align-items:center;gap:10px}
.tb-logo{
  width:34px;height:34px;border-radius:10px;
  background:linear-gradient(135deg,var(--teal),var(--sky));
  display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;
}
.tb-title{font-size:14px;font-weight:700;letter-spacing:-0.4px;line-height:1.1}
.tb-sub{font-size:10px;color:var(--fog);letter-spacing:0.2px}
.tb-month{
  font-family:'JetBrains Mono',monospace;
  font-size:11px;font-weight:600;
  background:var(--ink3);border:1px solid var(--line2);
  border-radius:20px;padding:5px 11px;color:var(--teal);
}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;padding:16px;padding-bottom:90px;animation:rise 0.22s ease}
.screen.active{display:block}
@keyframes rise{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;
  background:rgba(13,17,23,0.96);
  backdrop-filter:blur(24px);
  border-top:1px solid var(--line);
  display:grid;grid-template-columns:repeat(4,1fr);
  padding:6px 0 22px;z-index:200;
}
.nb{
  background:none;border:none;color:var(--mist);
  display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:8px 4px;cursor:pointer;transition:color 0.18s;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.nb.on{color:var(--teal)}
.nb svg{width:20px;height:20px;stroke-width:1.8}
.nb span{font-size:10px;font-weight:600}

/* â”€â”€ UTILITIES â”€â”€ */
.card{
  background:var(--ink2);border:1px solid var(--line);
  border-radius:var(--r);padding:16px;margin-bottom:12px;
}
.cap{
  font-size:10px;font-weight:700;letter-spacing:1.2px;
  color:var(--mist);text-transform:uppercase;
  margin-bottom:10px;margin-top:2px;
}
.row{display:flex;align-items:center;justify-content:space-between}
.badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 9px;border-radius:99px;font-size:10px;font-weight:700;
  letter-spacing:0.3px;
}
.bg-teal{background:var(--teal2);color:var(--teal)}
.bg-amber{background:var(--amber2);color:var(--amber)}
.bg-rose{background:var(--rose2);color:var(--rose)}
.bg-sky{background:var(--sky2);color:var(--sky)}
.dot{width:5px;height:5px;border-radius:50%;background:currentColor}
.mono{font-family:'JetBrains Mono',monospace}

/* â”€â”€ STAT TILES â”€â”€ */
.tiles{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.tile{
  background:var(--ink2);border:1px solid var(--line);
  border-radius:var(--r);padding:14px;overflow:hidden;position:relative;
}
.tile::after{
  content:'';position:absolute;
  top:0;left:0;right:0;height:2px;
  background:var(--tc,var(--teal));
}
.tile-lbl{font-size:11px;color:var(--fog);margin-bottom:8px;font-weight:500}
.tile-num{
  font-size:28px;font-weight:800;line-height:1;
  font-family:'JetBrains Mono',monospace;
  color:var(--tc,var(--teal));
}
.tile-hint{font-size:10px;color:var(--mist);margin-top:5px}

/* â”€â”€ DONUT CHART â”€â”€ */
.donut-row{display:flex;align-items:center;gap:18px;padding:4px 0}
.donut-leg{flex:1}
.leg-row{display:flex;align-items:center;gap:8px;margin-bottom:9px}
.leg-sq{width:9px;height:9px;border-radius:3px;flex-shrink:0}
.leg-lbl{font-size:12px;color:var(--fog);flex:1}
.leg-n{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.prow{margin-bottom:11px}
.prow:last-child{margin-bottom:0}
.phdr{display:flex;justify-content:space-between;margin-bottom:5px}
.plbl{font-size:12px;font-weight:500}
.ppct{font-size:11px;font-family:'JetBrains Mono',monospace}
.pbar{height:5px;background:var(--ink4);border-radius:99px;overflow:hidden}
.pfill{height:100%;border-radius:99px;background:var(--pc,var(--teal));transition:width 0.9s cubic-bezier(.34,1.56,.64,1)}

/* â”€â”€ DEPT LIST â”€â”€ */
.drow{
  display:flex;align-items:center;gap:12px;
  padding:11px 0;border-bottom:1px solid var(--line);
  cursor:pointer;transition:opacity 0.15s;
}
.drow:last-child{border-bottom:none}
.drow:active{opacity:0.6}
.dico{
  width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.dinfo{flex:1;min-width:0}
.dname{font-size:13px;font-weight:600}
.dsub{font-size:11px;color:var(--fog);margin-top:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.dright{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.dpct{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace}
.chev{color:var(--mist);font-size:14px}

/* â”€â”€ SEARCH & FILTER â”€â”€ */
.searchbar{
  background:var(--ink2);border:1px solid var(--line);
  border-radius:var(--rs);padding:10px 13px;
  display:flex;align-items:center;gap:9px;margin-bottom:12px;
}
.searchbar input{
  flex:1;background:none;border:none;color:var(--snow);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;outline:none;
}
.searchbar input::placeholder{color:var(--mist)}
.ftabs{display:flex;gap:7px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}
.ftabs::-webkit-scrollbar{display:none}
.ftab{
  padding:5px 13px;border-radius:99px;font-size:11px;font-weight:700;
  border:1px solid var(--line2);background:var(--ink2);
  color:var(--fog);cursor:pointer;white-space:nowrap;transition:all 0.18s;
}
.ftab.on{background:var(--teal);border-color:var(--teal);color:#000}

/* â”€â”€ DETAIL â”€â”€ */
.back-btn{
  display:flex;align-items:center;gap:6px;
  color:var(--teal);font-size:13px;font-weight:600;
  cursor:pointer;margin-bottom:14px;
  background:none;border:none;padding:0;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.irow{
  display:flex;align-items:flex-start;gap:10px;
  padding:10px 0;border-bottom:1px solid var(--line);
}
.irow:last-child{border-bottom:none}
.inum{
  width:20px;height:20px;border-radius:6px;
  background:var(--ink4);display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:800;color:var(--fog);flex-shrink:0;margin-top:1px;
}
.iname{font-size:12px;flex:1;line-height:1.35;color:var(--fog)}
.ivals{text-align:right;min-width:80px}
.iact{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace}
.itgt{font-size:10px;color:var(--mist);margin-top:2px}

/* â”€â”€ SUBMIT FORM â”€â”€ */
.flbl{font-size:11px;font-weight:700;color:var(--fog);letter-spacing:0.4px;margin-bottom:6px}
.fsel,.finp{
  width:100%;background:var(--ink2);border:1px solid var(--line2);
  border-radius:var(--rs);color:var(--snow);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;
  padding:12px 14px;outline:none;appearance:none;
  transition:border-color 0.2s;margin-bottom:14px;
}
.fsel:focus,.finp:focus{border-color:var(--teal)}
.ind-block{
  background:var(--ink3);border:1px solid var(--line);
  border-radius:var(--rs);padding:12px;margin-bottom:9px;
}
.ind-lbl{font-size:11px;font-weight:700;color:var(--snow);margin-bottom:9px;line-height:1.3}
.ind-fields{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ind-fields input{
  background:var(--ink4);border:1px solid var(--line);
  border-radius:8px;color:var(--snow);
  font-family:'JetBrains Mono',monospace;font-size:14px;
  padding:10px;width:100%;outline:none;text-align:center;
  transition:border-color 0.2s;
}
.ind-fields input:focus{border-color:var(--teal)}
.ind-fields .flbl-sm{font-size:9px;font-weight:700;color:var(--mist);text-align:center;margin-top:4px;display:block;letter-spacing:0.5px;text-transform:uppercase}
.sbtn{
  width:100%;padding:15px;margin-top:6px;
  background:linear-gradient(135deg,var(--teal),var(--sky));
  border:none;border-radius:var(--rs);
  color:#000;font-family:'Plus Jakarta Sans',sans-serif;
  font-size:14px;font-weight:800;cursor:pointer;
  transition:opacity 0.2s;letter-spacing:-0.2px;
}
.sbtn:active{opacity:0.8}

/* â”€â”€ ALERT CARDS â”€â”€ */
.acard{
  display:flex;gap:11px;
  padding:13px;background:var(--ink2);
  border-radius:var(--rs);margin-bottom:10px;
  border-left:3px solid var(--ac,var(--teal));
}
.aico{font-size:18px;flex-shrink:0;margin-top:1px}
.adept{font-size:12px;font-weight:700;margin-bottom:3px}
.amsg{font-size:11px;color:var(--fog);line-height:1.45}
.atime{font-size:10px;color:var(--mist);margin-top:5px}

/* â”€â”€ TOAST â”€â”€ */
.toast{
  position:fixed;bottom:85px;left:50%;transform:translateX(-50%);
  background:var(--teal);color:#000;padding:11px 22px;
  border-radius:99px;font-size:12px;font-weight:800;
  box-shadow:0 4px 24px rgba(0,212,170,0.35);
  z-index:999;opacity:0;transition:opacity 0.3s;
  pointer-events:none;white-space:nowrap;letter-spacing:0.2px;
}
.toast.show{opacity:1}

/* â”€â”€ NO DATA â”€â”€ */
.empty{
  text-align:center;padding:40px 20px;
  color:var(--mist);
}
.empty-ico{font-size:44px;margin-bottom:12px}
.empty-title{font-size:15px;font-weight:700;color:var(--fog);margin-bottom:6px}
.empty-sub{font-size:12px;line-height:1.5}

h2{font-size:21px;font-weight:800;letter-spacing:-0.6px;margin-bottom:3px}
p.sub{font-size:12px;color:var(--fog);margin-bottom:14px}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="tb-brand">
    <div class="tb-logo">ğŸ¥</div>
    <div>
      <div class="tb-title">KCH Monitor</div>
      <div class="tb-sub">Technical Office Â· Kampong Chhnang</div>
    </div>
  </div>
  <div class="tb-month" id="hdr-month">2026-02</div>
</div>

<div class="toast" id="toast">âœ“ Report submitted</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="sc-dashboard">

  <!-- Stat tiles -->
  <div class="tiles">
    <div class="tile" style="--tc:var(--teal)">
      <div class="tile-lbl">Submitted</div>
      <div class="tile-num">18</div>
      <div class="tile-hint">of 31 departments</div>
    </div>
    <div class="tile" style="--tc:var(--rose)">
      <div class="tile-lbl">Pending</div>
      <div class="tile-num">13</div>
      <div class="tile-hint">not yet received</div>
    </div>
    <div class="tile" style="--tc:var(--sky)">
      <div class="tile-lbl">Avg Achievement</div>
      <div class="tile-num">91%</div>
      <div class="tile-hint">submitted depts</div>
    </div>
    <div class="tile" style="--tc:var(--amber)">
      <div class="tile-lbl">Alerts</div>
      <div class="tile-num">5</div>
      <div class="tile-hint">need attention</div>
    </div>
  </div>

  <!-- Submission overview donut -->
  <div class="card">
    <div class="row" style="margin-bottom:14px">
      <div style="font-size:14px;font-weight:700">Submission Status</div>
      <span class="badge bg-sky">Feb 2026</span>
    </div>
    <div class="donut-row">
      <!-- SVG donut -->
      <svg width="108" height="108" viewBox="0 0 108 108" style="flex-shrink:0">
        <circle cx="54" cy="54" r="38" fill="none" stroke="var(--ink4)" stroke-width="13"/>
        <!-- submitted: 18/31 = 58.1% = 239.1/411.5 arc -->
        <circle cx="54" cy="54" r="38" fill="none" stroke="var(--teal)" stroke-width="13"
          stroke-dasharray="238.76 0" stroke-dashoffset="357"
          transform="rotate(-90 54 54)" stroke-linecap="butt" opacity="0.9"/>
        <!-- late: 4/31 -->
        <circle cx="54" cy="54" r="38" fill="none" stroke="var(--amber)" stroke-width="13"
          stroke-dasharray="53.06 0" stroke-dashoffset="118.24"
          transform="rotate(-90 54 54)" stroke-linecap="butt" opacity="0.9"/>
        <!-- pending: 9/31 -->
        <circle cx="54" cy="54" r="38" fill="none" stroke="var(--rose)" stroke-width="13"
          stroke-dasharray="119.38 0" stroke-dashoffset="65.18"
          transform="rotate(-90 54 54)" stroke-linecap="butt" opacity="0.9"/>
        <text x="54" y="49" text-anchor="middle" fill="var(--snow)" font-size="16" font-weight="800" font-family="JetBrains Mono">58%</text>
        <text x="54" y="62" text-anchor="middle" fill="var(--fog)" font-size="9" font-family="Plus Jakarta Sans" font-weight="600">on time</text>
      </svg>
      <div class="donut-leg">
        <div class="leg-row"><div class="leg-sq" style="background:var(--teal)"></div><div class="leg-lbl">Submitted on time</div><div class="leg-n" style="color:var(--teal)">18</div></div>
        <div class="leg-row"><div class="leg-sq" style="background:var(--amber)"></div><div class="leg-lbl">Submitted late</div><div class="leg-n" style="color:var(--amber)">4</div></div>
        <div class="leg-row" style="margin-bottom:0"><div class="leg-sq" style="background:var(--rose)"></div><div class="leg-lbl">Not submitted</div><div class="leg-n" style="color:var(--rose)">9</div></div>
      </div>
    </div>
  </div>

  <!-- By category -->
  <div class="cap">By Category</div>
  <div class="card">
    <div class="prow">
      <div class="phdr"><span class="plbl">ğŸ¥ Clinical Services</span><span class="ppct" style="color:var(--teal)">13 / 18</span></div>
      <div class="pbar"><div class="pfill" style="--pc:var(--teal);width:72%"></div></div>
    </div>
    <div class="prow">
      <div class="phdr"><span class="plbl">ğŸ”¬ Supportive Services</span><span class="ppct" style="color:var(--amber)">3 / 8</span></div>
      <div class="pbar"><div class="pfill" style="--pc:var(--amber);width:37.5%"></div></div>
    </div>
    <div class="prow">
      <div class="phdr"><span class="plbl">ğŸ“‹ Administrative</span><span class="ppct" style="color:var(--sky)">2 / 5</span></div>
      <div class="pbar"><div class="pfill" style="--pc:var(--sky);width:40%"></div></div>
    </div>
  </div>

  <!-- Top performers -->
  <div class="cap">Top Performers This Month</div>
  <div class="card" style="padding:8px 16px">
    <div class="drow" onclick="openDept('ENT')">
      <div class="dico" style="background:rgba(0,212,170,0.12)">ğŸ‘‚</div>
      <div class="dinfo"><div class="dname">ENT</div><div class="dsub">All 10 indicators on target</div></div>
      <div class="dright"><div class="dpct" style="color:var(--teal)">98%</div></div>
    </div>
    <div class="drow" onclick="openDept('PMRS')">
      <div class="dico" style="background:rgba(56,189,248,0.12)">ğŸ’»</div>
      <div class="dinfo"><div class="dname">PMRS</div><div class="dsub">System uptime excellent</div></div>
      <div class="dright"><div class="dpct" style="color:var(--teal)">98%</div></div>
    </div>
    <div class="drow" onclick="openDept('Triage')">
      <div class="dico" style="background:rgba(244,63,94,0.12)">ğŸš¦</div>
      <div class="dinfo"><div class="dname">Triage</div><div class="dsub">Accuracy rate high</div></div>
      <div class="dright"><div class="dpct" style="color:var(--teal)">97%</div></div>
    </div>
  </div>

  <!-- Alerts preview -->
  <div class="cap">Active Alerts</div>
  <div class="acard" style="--ac:var(--rose)">
    <div class="aico">ğŸ”´</div>
    <div>
      <div class="adept">ICU â€” Ventilator utilization rate</div>
      <div class="amsg">Achievement 56% vs 70% target. Needs immediate review.</div>
      <div class="atime">Today Â· Critical</div>
    </div>
  </div>
  <div class="acard" style="--ac:var(--amber)">
    <div class="aico">âš ï¸</div>
    <div>
      <div class="adept">Laboratory â€” TAT routine tests</div>
      <div class="amsg">8.2 hrs average against 6 hr target. Chemistry section slowest.</div>
      <div class="atime">Today Â· Warning</div>
    </div>
  </div>
  <div class="acard" style="--ac:var(--rose)">
    <div class="aico">ğŸ“­</div>
    <div>
      <div class="adept">CSSD â€” Report overdue 2 days</div>
      <div class="amsg">Deadline was March 5. Contact CSSD head immediately.</div>
      <div class="atime">Overdue Â· Critical</div>
    </div>
  </div>


  <!-- Export Button -->
  <div style="margin-top:4px;margin-bottom:4px">
    <button onclick="exportExcel()" id="export-btn"
       style="display:flex;align-items:center;justify-content:center;gap:10px;
              width:100%;padding:15px;border-radius:10px;border:none;cursor:pointer;
              background:linear-gradient(135deg,#00D4AA,#38BDF8);
              color:#000;font-weight:800;font-size:14px;font-family:Plus Jakarta Sans,sans-serif;">
      ğŸ“¥  Export Full Report to Excel
    </button>
  </div>
  <div style="text-align:center;font-size:10px;color:#4A5568;margin-bottom:8px">
    Generates real .xlsx file Â· 4 sheets Â· Summary, Charts data, All Indicators, Alerts
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: DEPARTMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="sc-departments">
  <h2>Departments</h2>
  <p class="sub">31 departments Â· February 2026</p>

  <div class="searchbar">
    <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="var(--mist)" stroke-width="2.2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="dsearch" placeholder="Search departmentsâ€¦" oninput="filterD()">
  </div>
  <div class="ftabs" id="ftabs">
    <div class="ftab on" onclick="setF('all',this)">All (31)</div>
    <div class="ftab" onclick="setF('clinical',this)">Clinical</div>
    <div class="ftab" onclick="setF('supportive',this)">Supportive</div>
    <div class="ftab" onclick="setF('admin',this)">Admin</div>
    <div class="ftab" onclick="setF('pending',this)">Pending</div>
  </div>

  <div class="card" style="padding:4px 16px" id="dlist"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: DEPT DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="sc-detail">
  <button class="back-btn" onclick="goBack()">
    <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
    Departments
  </button>
  <div id="detail-body"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: SUBMIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="sc-submit">
  <h2>Submit Report</h2>
  <p class="sub">Enter your monthly indicator data below</p>

  <div class="flbl">Department</div>
  <select class="fsel" id="f-dept" onchange="loadInds()">
    <option value="">â€” Select your department â€”</option>
    <optgroup label="Clinical Services">
      <option>OPD</option><option>Emergency</option><option>Operation Theater</option>
      <option>General Surgery</option><option>General Medicine</option><option>ICU</option>
      <option>Gynecology</option><option>Maternity</option><option>Infectiology</option>
      <option>Ophthalmology</option><option>Pediatric</option><option>Neonatology</option>
      <option>Hemodialysis</option><option>OI Ward</option><option>ENT</option>
      <option>NCD Clinic</option><option>Physiotherapy</option><option>Triage</option>
    </optgroup>
    <optgroup label="Supportive Services">
      <option>Laboratory</option><option>Blood Bank</option><option>Radiology</option>
      <option>Ultrasound</option><option>Laundry</option><option>CSSD</option>
      <option>Kitchen</option><option>Cleaning</option>
    </optgroup>
    <optgroup label="Administrative Services">
      <option>PMRS</option><option>HEF-NSSF</option><option>Health Certification</option>
      <option>Cashier</option><option>Accounting</option>
    </optgroup>
  </select>

  <div class="flbl">Reporting Month</div>
  <input type="month" class="finp" id="f-month" value="2026-02">

  <div class="flbl">Your Name & Position</div>
  <input type="text" class="finp" id="f-name" placeholder="e.g. Mrs. Sok Chenda, OPD Head Nurse">

  <div id="ind-fields">
    <div class="empty">
      <div class="empty-ico">ğŸ“‹</div>
      <div class="empty-title">Select a Department</div>
      <div class="empty-sub">Indicators will appear here once you choose your department above.</div>
    </div>
  </div>

  <button class="sbtn" onclick="doSubmit()">Submit Monthly Report â†’</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: ALERTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="sc-alerts">
  <h2>Alerts</h2>
  <p class="sub">Issues requiring attention</p>

  <div class="ftabs">
    <div class="ftab on">All (5)</div>
    <div class="ftab">Critical (2)</div>
    <div class="ftab">Warning (3)</div>
  </div>

  <div class="acard" style="--ac:var(--rose)">
    <div class="aico">ğŸ”´</div>
    <div>
      <div class="adept">ICU â€” Ventilator utilization rate</div>
      <div class="amsg">Achievement 56% vs 70% target. Only 7 of 12 ventilators being tracked. Possible documentation gap or genuine low need. Verify with ICU Chief immediately.</div>
      <div class="atime">Today 08:12 Â· Critical</div>
    </div>
  </div>
  <div class="acard" style="--ac:var(--rose)">
    <div class="aico">ğŸ“­</div>
    <div>
      <div class="adept">CSSD â€” Report not submitted</div>
      <div class="amsg">Deadline was March 5, 2026. Report is now 2 days overdue. Contact CSSD Head to submit immediately or risk exclusion from hospital report.</div>
      <div class="atime">Overdue 2 days Â· Critical</div>
    </div>
  </div>
  <div class="acard" style="--ac:var(--amber)">
    <div class="aico">âš ï¸</div>
    <div>
      <div class="adept">Laboratory â€” Turnaround time (routine)</div>
      <div class="amsg">Average TAT 8.2 hours against 6-hour target. Chemistry section is most affected. Recommend staffing review and workflow analysis.</div>
      <div class="atime">Today 07:30 Â· Warning</div>
    </div>
  </div>
  <div class="acard" style="--ac:var(--amber)">
    <div class="aico">âš ï¸</div>
    <div>
      <div class="adept">Maternity â€” C-section rate</div>
      <div class="amsg">C-section rate at 42%, above WHO recommended 30% threshold. Request obstetric audit and review of surgical indications for the month.</div>
      <div class="atime">Yesterday 15:45 Â· Warning</div>
    </div>
  </div>
  <div class="acard" style="--ac:var(--amber)">
    <div class="aico">âš ï¸</div>
    <div>
      <div class="adept">General Surgery â€” 30-day readmission</div>
      <div class="amsg">Readmission rate 18% vs 15% target. Review discharge planning and post-discharge follow-up protocols for February cases.</div>
      <div class="atime">Yesterday 10:20 Â· Warning</div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bnav">
  <button class="nb on" onclick="showSc('dashboard',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
    <span>Dashboard</span>
  </button>
  <button class="nb" onclick="showSc('departments',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span>Departments</span>
  </button>
  <button class="nb" onclick="showSc('submit',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    <span>Submit</span>
  </button>
  <button class="nb" onclick="showSc('alerts',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    <span>Alerts</span>
  </button>
</nav>

<script>
// â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEPTS = [
  // Clinical
  {n:'OPD', cat:'clinical', ico:'ğŸ¥', bg:'rgba(0,212,170,0.12)', status:'submitted',
   sub:'581 visits Â· 10 indicators', pct:101, color:'var(--teal)',
   by:'Mrs. Sok Chenda', badge:'bg-teal',
   inds:[
     {n:'Total patient visits (new and follow-up)',t:575,a:581},
     {n:'Number of new patients registered',t:60,a:58},
     {n:'Number of follow-up patients',t:515,a:523},
     {n:'Average waiting time (minutes)',t:45,a:50},
     {n:'Patient satisfaction score (%)',t:85,a:90},
     {n:'Number of referrals to specialists',t:30,a:28},
     {n:'Number of patients referred out',t:15,a:12},
     {n:'Common diagnoses (top 5)',t:5,a:5},
     {n:'Medication dispensing compliance (%)',t:95,a:93},
     {n:'Patient no-show rate (%)',t:20,a:17},
   ]},
  {n:'Emergency', cat:'clinical', ico:'ğŸš¨', bg:'rgba(244,63,94,0.12)', status:'submitted',
   sub:'1,156 visits Â· 10 indicators', pct:94, color:'var(--teal)', by:'Dr. Kim Samnang', badge:'bg-teal',
   inds:[
     {n:'Total emergency visits',t:1200,a:1156},
     {n:'Triage category (Red/Yellow/Green)',t:100,a:97},
     {n:'Average door-to-doctor time (minutes)',t:20,a:24},
     {n:'Number of patients admitted from ED',t:320,a:312},
     {n:'Number of patients referred out',t:30,a:28},
     {n:'Number of deaths in ED',t:10,a:7},
     {n:'Resuscitation cases',t:20,a:23},
     {n:'Trauma cases',t:200,a:214},
     {n:'Medical emergency cases',t:150,a:143},
     {n:'Left Against Medical Advice (LAMA)',t:50,a:45},
   ]},
  {n:'Operation Theater', cat:'clinical', ico:'ğŸ”¬', bg:'rgba(167,139,250,0.12)', status:'submitted',
   sub:'123 surgeries Â· 10 indicators', pct:89, color:'var(--teal)', by:'Dr. Chan Bora', badge:'bg-teal',
   inds:[
     {n:'Total number of surgeries performed',t:130,a:123},
     {n:'Elective surgeries',t:85,a:79},
     {n:'Emergency surgeries',t:45,a:44},
     {n:'Surgery types breakdown',t:5,a:5},
     {n:'Cancelled surgeries',t:5,a:7},
     {n:'Average surgery duration by type',t:90,a:95},
     {n:'Utilization rate (%)',t:80,a:75},
     {n:'Anesthesia types used',t:3,a:3},
     {n:'Post-operative complications',t:5,a:8},
     {n:'Surgical site infections (SSI)',t:2,a:3},
   ]},
  {n:'General Surgery', cat:'clinical', ico:'ğŸ©º', bg:'rgba(56,189,248,0.12)', status:'submitted',
   sub:'145 admissions Â· 10 indicators', pct:96, color:'var(--teal)', by:'Dr. Pich Ratana', badge:'bg-teal',
   inds:[
     {n:'Total admissions',t:150,a:145},
     {n:'Total discharges',t:148,a:142},
     {n:'Average length of stay (ALOS)',t:5,a:5.2},
     {n:'Bed occupancy rate (%)',t:85,a:87},
     {n:'Bed turnover rate',t:6,a:5.8},
     {n:'Major surgical procedures performed',t:60,a:58},
     {n:'Minor surgical procedures performed',t:80,a:78},
     {n:'Post-operative complications',t:5,a:6},
     {n:'Mortality rate (%)',t:3,a:2.8},
     {n:'Readmission rate within 30 days (%)',t:15,a:18},
   ]},
  {n:'General Medicine', cat:'clinical', ico:'ğŸ’Š', bg:'rgba(0,212,170,0.12)', status:'submitted',
   sub:'210 admissions Â· 10 indicators', pct:91, color:'var(--teal)', by:'Dr. Heng Socheata', badge:'bg-teal',
   inds:[
     {n:'Total admissions',t:200,a:210},
     {n:'Total discharges',t:198,a:205},
     {n:'Average length of stay (ALOS)',t:6,a:6.4},
     {n:'Bed occupancy rate (%)',t:85,a:89},
     {n:'Common diagnoses (top 10)',t:10,a:10},
     {n:'Number of NCD patients',t:80,a:88},
     {n:'Number of infectious disease cases',t:40,a:45},
     {n:'Mortality rate (%)',t:4,a:3.8},
     {n:'Readmission rate (%)',t:12,a:13},
     {n:'Transfer to ICU cases',t:10,a:8},
   ]},
  {n:'ICU', cat:'clinical', ico:'â¤ï¸', bg:'rgba(244,63,94,0.12)', status:'submitted',
   sub:'âš ï¸ Ventilator alert Â· 10 indicators', pct:78, color:'var(--amber)', by:'Dr. Pich Vanna', badge:'bg-amber',
   inds:[
     {n:'Total admissions',t:40,a:38},
     {n:'Total discharges',t:38,a:35},
     {n:'Average length of stay (days)',t:4.5,a:5.2},
     {n:'Bed occupancy rate (%)',t:80,a:88},
     {n:'Ventilator utilization rate (%)',t:70,a:39},
     {n:'Central line utilization (%)',t:60,a:58},
     {n:'APACHE II average score',t:18,a:21},
     {n:'Mortality rate (%)',t:15,a:18.4},
     {n:'Unplanned extubation cases',t:0,a:2},
     {n:'VAP rate',t:0,a:0},
   ]},
  {n:'Gynecology', cat:'clinical', ico:'ğŸŒ¸', bg:'rgba(245,158,11,0.12)', status:'submitted',
   sub:'88 admissions Â· 10 indicators', pct:93, color:'var(--teal)', by:'Dr. Mao Channary', badge:'bg-teal',
   inds:[
     {n:'Total admissions',t:90,a:88},
     {n:'Total discharges',t:88,a:86},
     {n:'Total gynecological surgeries',t:55,a:52},
     {n:'Hysterectomy cases',t:10,a:9},
     {n:'Laparoscopy procedures',t:20,a:22},
     {n:'Pelvic surgeries',t:25,a:21},
     {n:'Cancer screening conducted',t:30,a:34},
     {n:'Average length of stay',t:4,a:4.2},
     {n:'Complications rate (%)',t:5,a:4.5},
     {n:'Readmission rate (%)',t:8,a:7},
   ]},
  {n:'Maternity', cat:'clinical', ico:'ğŸ‘¶', bg:'rgba(245,158,11,0.12)', status:'submitted',
   sub:'âš ï¸ C-section rate high Â· 10 indicators', pct:82, color:'var(--amber)', by:'Mrs. Keo Sophea', badge:'bg-amber',
   inds:[
     {n:'Total deliveries',t:95,a:98},
     {n:'Normal vaginal deliveries',t:65,a:57},
     {n:'Cesarean sections',t:30,a:41},
     {n:'C-section rate (%)',t:30,a:41.8},
     {n:'Maternal deaths',t:0,a:0},
     {n:'Stillbirths',t:2,a:3},
     {n:'Early neonatal deaths (0-7 days)',t:2,a:1},
     {n:'Pre-eclampsia/eclampsia cases',t:5,a:7},
     {n:'Postpartum hemorrhage cases',t:3,a:4},
     {n:'ANC 4+ visits rate (%)',t:75,a:78},
   ]},
  {n:'Infectiology', cat:'clinical', ico:'ğŸ¦ ', bg:'rgba(244,63,94,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Ophthalmology', cat:'clinical', ico:'ğŸ‘ï¸', bg:'rgba(56,189,248,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Pediatric', cat:'clinical', ico:'ğŸ§’', bg:'rgba(167,139,250,0.12)', status:'submitted',
   sub:'175 admissions Â· 10 indicators', pct:95, color:'var(--teal)', by:'Dr. Ly Sokha', badge:'bg-teal',
   inds:[
     {n:'Total admissions',t:170,a:175},
     {n:'Total discharges',t:168,a:172},
     {n:'Age distribution (<1,1-5,6-12,13-18)',t:4,a:4},
     {n:'Common diagnoses (top 10)',t:10,a:10},
     {n:'Vaccination coverage (%)',t:90,a:93},
     {n:'Malnutrition cases',t:20,a:18},
     {n:'Pneumonia cases',t:45,a:48},
     {n:'Diarrhea cases',t:30,a:27},
     {n:'Mortality rate (%)',t:2,a:1.7},
     {n:'Average length of stay',t:4,a:3.8},
   ]},
  {n:'Neonatology', cat:'clinical', ico:'ğŸ¼', bg:'rgba(245,158,11,0.12)', status:'submitted',
   sub:'62 admissions Â· 10 indicators', pct:88, color:'var(--teal)', by:'Dr. Noun Sreyla', badge:'bg-teal',
   inds:[
     {n:'Total admissions',t:60,a:62},
     {n:'Low birth weight babies (<2500g)',t:15,a:18},
     {n:'Premature babies (<37 weeks)',t:12,a:14},
     {n:'Birth asphyxia cases',t:5,a:4},
     {n:'Neonatal sepsis cases',t:8,a:10},
     {n:'Neonatal jaundice (phototherapy)',t:20,a:22},
     {n:'NICU mortality rate (%)',t:8,a:9.7},
     {n:'Average length of stay',t:7,a:7.5},
     {n:'Kangaroo mother care (KMC) cases',t:15,a:18},
     {n:'Successful breastfeeding rate (%)',t:80,a:75},
   ]},
  {n:'Hemodialysis', cat:'clinical', ico:'ğŸ’‰', bg:'rgba(56,189,248,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'OI Ward', cat:'clinical', ico:'ğŸ«', bg:'rgba(244,63,94,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'ENT', cat:'clinical', ico:'ğŸ‘‚', bg:'rgba(0,212,170,0.12)', status:'submitted',
   sub:'245 OPD visits Â· 10 indicators', pct:98, color:'var(--teal)', by:'Dr. Sam Vutha', badge:'bg-teal',
   inds:[
     {n:'Total OPD visits',t:240,a:245},
     {n:'Ear infections cases',t:60,a:58},
     {n:'Hearing loss cases',t:20,a:22},
     {n:'Tonsillectomy performed',t:15,a:16},
     {n:'Adenoidectomy performed',t:8,a:9},
     {n:'Nasal surgeries',t:12,a:11},
     {n:'Throat surgeries',t:10,a:10},
     {n:'ENT trauma cases',t:15,a:14},
     {n:'Surgical complications',t:1,a:0},
     {n:'Patient satisfaction (%)',t:88,a:91},
   ]},
  {n:'NCD Clinic', cat:'clinical', ico:'ğŸ’“', bg:'rgba(167,139,250,0.12)', status:'submitted',
   sub:'380 visits Â· 10 indicators', pct:92, color:'var(--teal)', by:'Dr. Chea Bopha', badge:'bg-teal',
   inds:[
     {n:'Total patient visits',t:370,a:380},
     {n:'Hypertension cases',t:140,a:152},
     {n:'Diabetes cases',t:110,a:118},
     {n:'COPD/Asthma cases',t:45,a:42},
     {n:'Cardiovascular disease cases',t:35,a:38},
     {n:'Chronic kidney disease cases',t:20,a:18},
     {n:'Cancer follow-up cases',t:25,a:27},
     {n:'Blood pressure control rate (%)',t:70,a:68},
     {n:'Blood sugar control rate (%)',t:65,a:62},
     {n:'Medication adherence rate (%)',t:85,a:83},
   ]},
  {n:'Physiotherapy', cat:'clinical', ico:'ğŸ¦½', bg:'rgba(56,189,248,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Triage', cat:'clinical', ico:'ğŸš¦', bg:'rgba(244,63,94,0.12)', status:'submitted',
   sub:'1,156 triaged Â· 10 indicators', pct:97, color:'var(--teal)', by:'Mrs. Ly Kosal', badge:'bg-teal',
   inds:[
     {n:'Total patients triaged',t:1150,a:1156},
     {n:'Red (Immediate) cases',t:80,a:87},
     {n:'Yellow (Urgent) cases',t:450,a:463},
     {n:'Green (Non-urgent) cases',t:620,a:606},
     {n:'Average triage time (minutes)',t:5,a:4.8},
     {n:'Over-triage rate (%)',t:5,a:4.2},
     {n:'Under-triage rate (%)',t:1,a:0.8},
     {n:'Triage accuracy rate (%)',t:95,a:96.5},
     {n:'Patients waiting >30 minutes',t:30,a:24},
     {n:'Staff competency assessment (%)',t:90,a:92},
   ]},
  // Supportive
  {n:'Laboratory', cat:'supportive', ico:'ğŸ”¬', bg:'rgba(56,189,248,0.12)', status:'submitted',
   sub:'âš ï¸ TAT exceeds target Â· 10 indicators', pct:83, color:'var(--amber)', by:'Mr. Pov Dara', badge:'bg-amber',
   inds:[
     {n:'Total tests performed',t:1200,a:1300},
     {n:'Hematology tests',t:400,a:450},
     {n:'Clinical chemistry tests',t:350,a:380},
     {n:'Microbiology tests',t:100,a:120},
     {n:'Serology tests',t:90,a:95},
     {n:'Urinalysis tests',t:180,a:200},
     {n:'Turnaround time - routine (hours)',t:6,a:8.2},
     {n:'TAT - urgent (minutes)',t:60,a:55},
     {n:'Critical value reporting time',t:30,a:28},
     {n:'Quality control compliance (%)',t:95,a:97},
   ]},
  {n:'Blood Bank', cat:'supportive', ico:'ğŸ©¸', bg:'rgba(244,63,94,0.12)', status:'submitted',
   sub:'182 units issued Â· 10 indicators', pct:91, color:'var(--teal)', by:'Mrs. Mao Sophea', badge:'bg-teal',
   inds:[
     {n:'Blood units collected',t:80,a:85},
     {n:'Blood units issued',t:175,a:182},
     {n:'Blood type distribution',t:4,a:4},
     {n:'Wastage rate (%)',t:3,a:2.5},
     {n:'Stock level (units available)',t:50,a:48},
     {n:'Emergency requests fulfilled (%)',t:100,a:100},
     {n:'Transfusion reactions reported',t:0,a:1},
     {n:'Cross-match to transfusion ratio',t:1.5,a:1.4},
     {n:'Blood donor screening positives',t:5,a:4},
     {n:'Regular donors vs first-time donors',t:60,a:58},
   ]},
  {n:'Radiology', cat:'supportive', ico:'ğŸ“¡', bg:'rgba(167,139,250,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Ultrasound', cat:'supportive', ico:'ğŸ”Š', bg:'rgba(56,189,248,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Laundry', cat:'supportive', ico:'ğŸ§º', bg:'rgba(0,212,170,0.12)', status:'submitted',
   sub:'4,250 kg processed Â· 10 indicators', pct:96, color:'var(--teal)', by:'Mr. Noun Ratha', badge:'bg-teal',
   inds:[
     {n:'Total kg of laundry processed',t:4200,a:4250},
     {n:'Clean linen distributed (kg)',t:2000,a:2050},
     {n:'Surgical linen processed (kg)',t:800,a:820},
     {n:'Patient clothing processed (kg)',t:1400,a:1380},
     {n:'Lost or damaged items',t:5,a:3},
     {n:'Turnaround time (hours)',t:24,a:22},
     {n:'Quality compliance (%)',t:95,a:97},
     {n:'Infection control compliance (%)',t:95,a:96},
     {n:'Machine utilization rate (%)',t:80,a:83},
     {n:'Stock level adequacy (%)',t:90,a:92},
   ]},
  {n:'CSSD', cat:'supportive', ico:'â™¨ï¸', bg:'rgba(245,158,11,0.12)', status:'pending', sub:'âš ï¸ Overdue 2 days', pct:null, badge:'bg-rose', inds:[]},
  {n:'Kitchen', cat:'supportive', ico:'ğŸ½ï¸', bg:'rgba(0,212,170,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Cleaning', cat:'supportive', ico:'ğŸ§¹', bg:'rgba(56,189,248,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  // Administrative
  {n:'PMRS', cat:'admin', ico:'ğŸ’»', bg:'rgba(56,189,248,0.12)', status:'submitted',
   sub:'1,260 registrations Â· 10 indicators', pct:98, color:'var(--teal)', by:'Ms. Chan Bopha', badge:'bg-teal',
   inds:[
     {n:'Total patients registered',t:1200,a:1260},
     {n:'New patient registrations',t:58,a:62},
     {n:'Duplicate records identified and merged',t:5,a:3},
     {n:'System downtime (hours)',t:2,a:0.5},
     {n:'Data entry error rate (%)',t:2,a:1.2},
     {n:'MRN generation accuracy (%)',t:99,a:99.8},
     {n:'Patient demographic updates',t:50,a:48},
     {n:'Registration waiting time (minutes)',t:10,a:8},
     {n:'System backup completion (%)',t:100,a:100},
     {n:'Staff training completion (%)',t:100,a:100},
   ]},
  {n:'HEF-NSSF', cat:'admin', ico:'ğŸ›ï¸', bg:'rgba(0,212,170,0.12)', status:'submitted',
   sub:'86 HEF + 142 NSSF Â· 10 indicators', pct:94, color:'var(--teal)', by:'Mr. Sok Kimheng', badge:'bg-teal',
   inds:[
     {n:'Total HEF patients served',t:80,a:86},
     {n:'Total NSSF patients served',t:135,a:142},
     {n:'HEF claims submitted',t:80,a:84},
     {n:'NSSF claims submitted',t:135,a:140},
     {n:'Claim approval rate (%)',t:90,a:92},
     {n:'Claim rejection rate (%)',t:10,a:8},
     {n:'Average claim processing time (days)',t:7,a:6.5},
     {n:'Patient complaints received',t:2,a:1},
     {n:'Bypass cases (NSSF)',t:0,a:2},
     {n:'Coverage verification time (minutes)',t:15,a:12},
   ]},
  {n:'Health Certification', cat:'admin', ico:'ğŸ“œ', bg:'rgba(245,158,11,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Cashier', cat:'admin', ico:'ğŸ’µ', bg:'rgba(0,212,170,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
  {n:'Accounting', cat:'admin', ico:'ğŸ“Š', bg:'rgba(167,139,250,0.12)', status:'pending', sub:'Not submitted', pct:null, badge:'bg-rose', inds:[]},
];

const IND_NAMES = {};
DEPTS.forEach(d => { IND_NAMES[d.n] = d.inds.length ? d.inds.map(i=>i.n) : []; });

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function color(pct){
  if(pct===null||pct===undefined) return 'var(--mist)';
  if(pct>=90) return 'var(--teal)';
  if(pct>=75) return 'var(--amber)';
  return 'var(--rose)';
}

function pct(a,t){ return t>0 ? Math.round((a/t)*100) : 0; }

// â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSc(name, btn){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('sc-'+name).classList.add('active');
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  if(btn) btn.classList.add('on');
}

// â”€â”€â”€ DEPT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fMode='all';
function renderDlist(){
  const q = document.getElementById('dsearch').value.toLowerCase();
  const list = document.getElementById('dlist');
  let html='';
  DEPTS.forEach(d=>{
    const show = d.n.toLowerCase().includes(q) &&
      (fMode==='all' || fMode===d.cat || (fMode==='pending' && d.status==='pending'));
    if(!show) return;
    const c = d.pct!==null ? color(d.pct) : 'var(--mist)';
    const pctTxt = d.pct!==null ? d.pct+'%' : 'â€”';
    html += `<div class="drow" onclick="openDept('${d.n}')">
      <div class="dico" style="background:${d.bg}">${d.ico}</div>
      <div class="dinfo">
        <div class="dname">${d.n}</div>
        <div class="dsub">${d.sub}</div>
      </div>
      <div class="dright">
        <div class="dpct" style="color:${c}">${pctTxt}</div>
        <span class="badge ${d.badge}"><span class="dot"></span>${d.status==='submitted'?'Submitted':d.status==='pending'?'Pending':'Late'}</span>
      </div>
    </div>`;
  });
  list.innerHTML = html || '<div class="empty"><div class="empty-ico">ğŸ”</div><div class="empty-title">No results</div></div>';
}
function filterD(){ renderDlist(); }
function setF(mode,el){
  fMode=mode;
  document.querySelectorAll('.ftab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  renderDlist();
}

// â”€â”€â”€ OPEN DEPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDept(name){
  const d = DEPTS.find(x=>x.n===name);
  const body = document.getElementById('detail-body');

  if(!d || d.status==='pending'){
    body.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
        <div class="dico" style="background:${d?.bg||'var(--ink4)'};width:42px;height:42px;font-size:20px">${d?.ico||'ğŸ¥'}</div>
        <div>
          <div style="font-size:18px;font-weight:800">${name}</div>
          <div style="font-size:12px;color:var(--fog)">${d?.cat==='clinical'?'Clinical Service':d?.cat==='supportive'?'Supportive Service':'Administrative'}</div>
        </div>
      </div>
      <div class="card" style="text-align:center;padding:36px 20px">
        <div class="empty-ico">ğŸ“­</div>
        <div class="empty-title">No Report Submitted</div>
        <div class="empty-sub">This department has not submitted their February 2026 monthly report yet${d?.sub?.includes('Overdue')?' â€” and is overdue':''}.</div>
        <button class="sbtn" style="width:auto;padding:12px 24px;margin-top:18px;font-size:13px" onclick="showSc('submit',document.querySelectorAll('.nb')[2])">Submit Report Now â†’</button>
      </div>`;
    showSc('detail',null);
    return;
  }

  const achieved = d.inds.map(i=>pct(i.a,i.t));
  const avg = Math.round(achieved.reduce((s,v)=>s+v,0)/achieved.length);
  const onTarget = achieved.filter(p=>p>=85).length;

  const bars = d.inds.map((ind,i)=>{
    const p = achieved[i]; const c = color(p); const w = Math.min(p,130);
    return `<div class="prow">
      <div class="phdr"><span class="plbl" style="font-size:11px;color:var(--fog)">${ind.n}</span><span class="ppct" style="color:${c}">${p}%</span></div>
      <div class="pbar"><div class="pfill" style="--pc:${c};width:${w}%"></div></div>
    </div>`;
  }).join('');

  const rows = d.inds.map((ind,i)=>{
    const p = achieved[i]; const c = color(p);
    return `<div class="irow">
      <div class="inum">${i+1}</div>
      <div class="iname">${ind.n}</div>
      <div class="ivals">
        <div class="iact mono" style="color:${c}">${ind.a}</div>
        <div class="itgt">Target: ${ind.t}</div>
      </div>
    </div>`;
  }).join('');

  body.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <div class="dico" style="background:${d.bg};width:44px;height:44px;font-size:22px">${d.ico}</div>
      <div>
        <div style="font-size:19px;font-weight:800">${name}</div>
        <div style="font-size:11px;color:var(--fog)">By ${d.by} Â· February 2026</div>
      </div>
    </div>

    <div class="tiles" style="margin-bottom:12px">
      <div class="tile" style="--tc:${color(avg)}">
        <div class="tile-lbl">Avg Achievement</div>
        <div class="tile-num">${avg}%</div>
        <div class="tile-hint">overall</div>
      </div>
      <div class="tile" style="--tc:var(--teal)">
        <div class="tile-lbl">On Target</div>
        <div class="tile-num">${onTarget}</div>
        <div class="tile-hint">of 10 indicators</div>
      </div>
    </div>

    <div class="cap">Performance by Indicator</div>
    <div class="card">${bars}</div>

    <div class="cap">Detailed Data</div>
    <div class="card" style="padding:8px 14px">${rows}</div>
  `;

  showSc('detail',null);
}

function goBack(){
  showSc('departments', document.querySelectorAll('.nb')[1]);
}

// â”€â”€â”€ SUBMIT FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadInds(){
  const dept = document.getElementById('f-dept').value;
  const container = document.getElementById('ind-fields');
  if(!dept){
    container.innerHTML=`<div class="empty"><div class="empty-ico">ğŸ“‹</div><div class="empty-title">Select a Department</div><div class="empty-sub">Indicators will appear once you choose your department.</div></div>`;
    return;
  }
  const d = DEPTS.find(x=>x.n===dept);
  // Use existing indicators or build from known data
  let names = d && d.inds.length ? d.inds.map(i=>i.n) : (IND_NAMES[dept]||Array.from({length:10},(_,i)=>`Indicator ${i+1}`));
  container.innerHTML = names.map((nm,i)=>`
    <div class="ind-block">
      <div class="ind-lbl">${i+1}. ${nm}</div>
      <div class="ind-fields">
        <div>
          <input type="number" id="t${i}" placeholder="0" min="0" step="any">
          <label class="flbl-sm">Target</label>
        </div>
        <div>
          <input type="number" id="a${i}" placeholder="0" min="0" step="any">
          <label class="flbl-sm">Actual</label>
        </div>
      </div>
    </div>`).join('');
}

function doSubmit(){
  const dept = document.getElementById('f-dept').value;
  const name = document.getElementById('f-name').value.trim();
  if(!dept){ alert('Please select your department.'); return; }
  if(!name){ alert('Please enter your name and position.'); return; }
  const t = document.getElementById('toast');
  t.textContent = `âœ“ ${dept} report submitted`;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
  document.getElementById('f-dept').value='';
  document.getElementById('f-name').value='';
  loadInds();
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderDlist();
const now = new Date();
document.getElementById('hdr-month').textContent =
  now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
</script>

<!-- SheetJS for in-browser Excel generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

// â”€â”€â”€ EXCEL EXPORT FUNCTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportExcel() {
  const btn = document.getElementById('export-btn');
  btn.textContent = 'â³  Generating Excel...';
  btn.disabled = true;

  setTimeout(() => {
    try {
      const wb = XLSX.utils.book_new();

      // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function pct(a, t) {
        if (!t || t === 0) return (a === 0 ? 1 : 0.5);
        return a / t;
      }
      function pctLabel(v) {
        if (v >= 0.9)  return 'On Target';
        if (v >= 0.75) return 'Below Target';
        return 'Critical';
      }
      function deptAvg(inds) {
        if (!inds || !inds.length) return null;
        const vals = inds.map(i => pct(i[2], i[1]) * 100);
        return Math.round(vals.reduce((s, v) => s + v, 0) / vals.length * 10) / 10;
      }

      // â”€â”€ ALL DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const DEPTS = [
        ["OPD","Clinical","Submitted","Mrs. Sok Chenda",[
          ["Total patient visits",575,581],["New patients registered",60,58],
          ["Follow-up patients",515,523],["Avg waiting time (min)",45,50],
          ["Patient satisfaction (%)",85,90],["Referrals to specialists",30,28],
          ["Patients referred out",15,12],["Common diagnoses tracked",5,5],
          ["Medication compliance (%)",95,93],["No-show rate (%)",20,17]]],
        ["Emergency","Clinical","Submitted","Dr. Kim Samnang",[
          ["Total emergency visits",1200,1156],["Triage distribution",100,97],
          ["Door-to-doctor time (min)",20,24],["Patients admitted from ED",320,312],
          ["Patients referred out",30,28],["Deaths in ED",10,7],
          ["Resuscitation cases",20,23],["Trauma cases",200,214],
          ["Medical emergency cases",150,143],["LAMA cases",50,45]]],
        ["Operation Theater","Clinical","Submitted","Dr. Chan Bora",[
          ["Total surgeries",130,123],["Elective surgeries",85,79],
          ["Emergency surgeries",45,44],["Surgery categories",5,5],
          ["Cancelled surgeries",5,7],["Avg surgery duration (min)",90,95],
          ["Utilization rate (%)",80,75],["Anesthesia types used",3,3],
          ["Post-op complications",5,8],["Surgical site infections",2,3]]],
        ["General Surgery","Clinical","Submitted","Dr. Pich Ratana",[
          ["Total admissions",150,145],["Total discharges",148,142],
          ["ALOS (days)",5,5.2],["Bed occupancy (%)",85,87],
          ["Bed turnover rate",6,5.8],["Major procedures",60,58],
          ["Minor procedures",80,78],["Post-op complications",5,6],
          ["Mortality rate (%)",3,2.8],["30-day readmission (%)",15,18]]],
        ["General Medicine","Clinical","Submitted","Dr. Heng Socheata",[
          ["Total admissions",200,210],["Total discharges",198,205],
          ["ALOS (days)",6,6.4],["Bed occupancy (%)",85,89],
          ["Common diagnoses tracked",10,10],["NCD patients",80,88],
          ["Infectious disease cases",40,45],["Mortality rate (%)",4,3.8],
          ["Readmission rate (%)",12,13],["Transfer to ICU",10,8]]],
        ["ICU","Clinical","Submitted","Dr. Pich Vanna",[
          ["Total admissions",40,38],["Total discharges",38,35],
          ["ALOS (days)",4.5,5.2],["Bed occupancy (%)",80,88],
          ["Ventilator utilization (%)",70,39],["Central line utilization (%)",60,58],
          ["APACHE II avg score",18,21],["Mortality rate (%)",15,18.4],
          ["Unplanned extubations",1,2],["VAP cases",1,0]]],
        ["Gynecology","Clinical","Submitted","Dr. Mao Channary",[
          ["Total admissions",90,88],["Total discharges",88,86],
          ["Gynecological surgeries",55,52],["Hysterectomy cases",10,9],
          ["Laparoscopy procedures",20,22],["Pelvic surgeries",25,21],
          ["Cancer screening done",30,34],["ALOS (days)",4,4.2],
          ["Complications rate (%)",5,4.5],["Readmission rate (%)",8,7]]],
        ["Maternity","Clinical","Submitted","Mrs. Keo Sophea",[
          ["Total deliveries",95,98],["Normal vaginal deliveries",65,57],
          ["Cesarean sections",30,41],["C-section rate (%)",30,41.8],
          ["Maternal deaths",1,0],["Stillbirths",2,3],
          ["Early neonatal deaths",2,1],["Pre-eclampsia cases",5,7],
          ["PPH cases",3,4],["ANC 4+ visits rate (%)",75,78]]],
        ["Infectiology","Clinical","Pending","â€”",[]],
        ["Ophthalmology","Clinical","Pending","â€”",[]],
        ["Pediatric","Clinical","Submitted","Dr. Ly Sokha",[
          ["Total admissions",170,175],["Total discharges",168,172],
          ["Age distribution tracked",4,4],["Common diagnoses",10,10],
          ["Vaccination coverage (%)",90,93],["Malnutrition cases",20,18],
          ["Pneumonia cases",45,48],["Diarrhea cases",30,27],
          ["Mortality rate (%)",2,1.7],["ALOS (days)",4,3.8]]],
        ["Neonatology","Clinical","Submitted","Dr. Noun Sreyla",[
          ["Total admissions",60,62],["Low birth weight <2500g",15,18],
          ["Premature babies <37wk",12,14],["Birth asphyxia cases",5,4],
          ["Neonatal sepsis cases",8,10],["Jaundice (phototherapy)",20,22],
          ["NICU mortality (%)",8,9.7],["ALOS (days)",7,7.5],
          ["KMC cases",15,18],["Breastfeeding success (%)",80,75]]],
        ["Hemodialysis","Clinical","Pending","â€”",[]],
        ["OI Ward","Clinical","Pending","â€”",[]],
        ["ENT","Clinical","Submitted","Dr. Sam Vutha",[
          ["Total OPD visits",240,245],["Ear infections",60,58],
          ["Hearing loss cases",20,22],["Tonsillectomy",15,16],
          ["Adenoidectomy",8,9],["Nasal surgeries",12,11],
          ["Throat surgeries",10,10],["ENT trauma cases",15,14],
          ["Surgical complications",1,0],["Patient satisfaction (%)",88,91]]],
        ["NCD Clinic","Clinical","Submitted","Dr. Chea Bopha",[
          ["Total patient visits",370,380],["Hypertension cases",140,152],
          ["Diabetes cases",110,118],["COPD/Asthma cases",45,42],
          ["Cardiovascular cases",35,38],["Chronic kidney disease",20,18],
          ["Cancer follow-up cases",25,27],["BP control rate (%)",70,68],
          ["Blood sugar control (%)",65,62],["Medication adherence (%)",85,83]]],
        ["Physiotherapy","Clinical","Pending","â€”",[]],
        ["Triage","Clinical","Submitted","Mrs. Ly Kosal",[
          ["Total patients triaged",1150,1156],["Red cases",80,87],
          ["Yellow cases",450,463],["Green cases",620,606],
          ["Avg triage time (min)",5,4.8],["Over-triage rate (%)",5,4.2],
          ["Under-triage rate (%)",1,0.8],["Triage accuracy (%)",95,96.5],
          ["Patients waiting >30min",30,24],["Staff competency (%)",90,92]]],
        ["Laboratory","Supportive","Submitted","Mr. Pov Dara",[
          ["Total tests performed",1200,1300],["Hematology tests",400,450],
          ["Chemistry tests",350,380],["Microbiology tests",100,120],
          ["Serology tests",90,95],["Urinalysis tests",180,200],
          ["TAT routine (hours)",6,8.2],["TAT urgent (minutes)",60,55],
          ["Critical value reporting (min)",30,28],["QC compliance (%)",95,97]]],
        ["Blood Bank","Supportive","Submitted","Mrs. Mao Sophea",[
          ["Blood units collected",80,85],["Blood units issued",175,182],
          ["Blood type categories",4,4],["Wastage rate (%)",3,2.5],
          ["Stock level (units)",50,48],["Emergency requests met (%)",100,100],
          ["Transfusion reactions",1,1],["Cross-match ratio",1.5,1.4],
          ["Donor screening positives",5,4],["Regular vs first-time donors",60,58]]],
        ["Radiology","Supportive","Pending","â€”",[]],
        ["Ultrasound","Supportive","Pending","â€”",[]],
        ["Laundry","Supportive","Submitted","Mr. Noun Ratha",[
          ["Total laundry processed (kg)",4200,4250],["Clean linen (kg)",2000,2050],
          ["Surgical linen (kg)",800,820],["Patient clothing (kg)",1400,1380],
          ["Lost/damaged items",5,3],["Turnaround time (hours)",24,22],
          ["Quality compliance (%)",95,97],["IPC compliance (%)",95,96],
          ["Machine utilization (%)",80,83],["Stock adequacy (%)",90,92]]],
        ["CSSD","Supportive","Pending","â€”",[]],
        ["Kitchen","Supportive","Pending","â€”",[]],
        ["Cleaning","Supportive","Pending","â€”",[]],
        ["PMRS","Administrative","Submitted","Ms. Chan Bopha",[
          ["Total patients registered",1200,1260],["New registrations",58,62],
          ["Duplicate records merged",5,3],["System downtime (hours)",2,0.5],
          ["Data entry error rate (%)",2,1.2],["MRN accuracy (%)",99,99.8],
          ["Demographic updates",50,48],["Registration wait (min)",10,8],
          ["Backup completion (%)",100,100],["Staff training (%)",100,100]]],
        ["HEF-NSSF","Administrative","Submitted","Mr. Sok Kimheng",[
          ["Total HEF patients",80,86],["Total NSSF patients",135,142],
          ["HEF claims submitted",80,84],["NSSF claims submitted",135,140],
          ["Claim approval rate (%)",90,92],["Claim rejection rate (%)",10,8],
          ["Avg processing time (days)",7,6.5],["Patient complaints",2,1],
          ["Bypass cases (NSSF)",1,2],["Verification time (min)",15,12]]],
        ["Health Certification","Administrative","Pending","â€”",[]],
        ["Cashier","Administrative","Pending","â€”",[]],
        ["Accounting","Administrative","Pending","â€”",[]],
      ];

      const submitted = DEPTS.filter(d => d[2] === "Submitted" && d[4].length > 0);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SHEET 1: SUMMARY DASHBOARD
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const s1data = [];

      // Title rows
      s1data.push(["KAMPONG CHHNANG PROVINCIAL HOSPITAL â€” TECHNICAL OFFICE"]);
      s1data.push(["Monthly Report Export  |  February 2026  |  Generated: " + new Date().toLocaleDateString()]);
      s1data.push([]);

      // KPI summary
      s1data.push(["KPI SUMMARY",,,,,,,,,]);
      s1data.push(["Submitted","18 / 31","","Pending","13 / 31","","Avg Achievement","91.2%","","Active Alerts","5"]);
      s1data.push([]);

      // Submission by category
      s1data.push(["SUBMISSION BY CATEGORY"]);
      s1data.push(["Category","Submitted","Pending","Total","Submission Rate"]);
      s1data.push(["Clinical Services",13,5,18,"72.2%"]);
      s1data.push(["Supportive Services",3,5,8,"37.5%"]);
      s1data.push(["Administrative",2,3,5,"40.0%"]);
      s1data.push(["TOTAL",18,13,31,"58.1%"]);
      s1data.push([]);

      // All departments table
      s1data.push(["ALL DEPARTMENTS â€” FEBRUARY 2026"]);
      s1data.push(["#","Department","Category","Status","Submitted By",
                   "Target Avg","Actual Avg","Achievement %","On Target (of 10)","Notes"]);

      DEPTS.forEach((d, idx) => {
        const [name, cat, status, by, inds] = d;
        const avg = deptAvg(inds);
        const tgAvg = inds.length ? (inds.reduce((s,i)=>s+i[1],0)/inds.length).toFixed(1) : "â€”";
        const acAvg = inds.length ? (inds.reduce((s,i)=>s+i[2],0)/inds.length).toFixed(1) : "â€”";
        const onTgt = inds.length ? inds.filter(i => pct(i[2],i[1]) >= 0.85).length : "â€”";
        const note = name==="ICU" ? "âš  Ventilator 56% vs 70% target"
                   : name==="Maternity" ? "âš  C-section 41.8% vs 30%"
                   : name==="Laboratory" ? "âš  TAT 8.2h vs 6h target"
                   : name==="CSSD" ? "ğŸ”´ Report overdue 2 days" : "";
        s1data.push([
          idx+1, name, cat, status, by,
          tgAvg, acAvg,
          avg ? (avg/100).toFixed(3) : "â€”",
          onTgt, note
        ]);
      });

      const ws1 = XLSX.utils.aoa_to_sheet(s1data);

      // Column widths
      ws1['!cols'] = [
        {wch:4},{wch:28},{wch:16},{wch:12},{wch:22},
        {wch:12},{wch:12},{wch:14},{wch:14},{wch:32}
      ];

      // Format achievement % cells as percentage
      // Row offset: title(1)+subtitle(1)+blank(1)+kpi_hdr(1)+kpi(1)+blank(1)+cat_hdr(1)+cat_cols(1)+3 cat rows+total+blank+dept_hdr+cols = row 15 (0-indexed 14) for first dept
      const deptRowStart = 14; // 0-indexed
      for (let i = 0; i < DEPTS.length; i++) {
        const cellAddr = XLSX.utils.encode_cell({r: deptRowStart + i, c: 7}); // col H = achievement
        if (ws1[cellAddr] && ws1[cellAddr].v !== "â€”") {
          ws1[cellAddr].t = 'n';
          ws1[cellAddr].z = '0.0%';
        }
      }

      XLSX.utils.book_append_sheet(wb, ws1, "Summary Dashboard");

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SHEET 2: CHARTS DATA
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const s2data = [];
      s2data.push(["CHARTS DATA â€” FEBRUARY 2026"]);
      s2data.push(["Note: Open this sheet in Excel and use Insert â†’ Chart to visualize"]);
      s2data.push([]);

      // Table A: Achievement by dept
      s2data.push(["TABLE A: Achievement % by Submitted Department (for Bar Chart)"]);
      s2data.push(["Department","Achievement %","Target %","Category"]);
      submitted.forEach(([name, cat, , , inds]) => {
        s2data.push([name, deptAvg(inds)/100, 1.0, cat]);
      });
      s2data.push([]);

      // Table B: Submission status (for Pie)
      s2data.push(["TABLE B: Submission Status (for Pie Chart)"]);
      s2data.push(["Status","Count","Percentage"]);
      s2data.push(["Submitted on time",18,"58.1%"]);
      s2data.push(["Not submitted",13,"41.9%"]);
      s2data.push([]);

      // Table C: By category (for stacked bar)
      s2data.push(["TABLE C: By Service Category (for Stacked Bar)"]);
      s2data.push(["Category","Submitted","Pending","Total"]);
      s2data.push(["Clinical Services",13,5,18]);
      s2data.push(["Supportive Services",3,5,8]);
      s2data.push(["Administrative",2,3,5]);
      s2data.push([]);

      // Table D: Ranked performance
      const ranked = submitted
        .map(([name,,,,inds]) => [name, deptAvg(inds)])
        .sort((a,b) => b[1]-a[1]);
      s2data.push(["TABLE D: Departments Ranked by Achievement % (for Ranking Chart)"]);
      s2data.push(["Rank","Department","Achievement %"]);
      ranked.forEach(([name, avg], i) => {
        s2data.push([i+1, name, avg/100]);
      });
      s2data.push([]);

      // Monthly trend placeholder
      s2data.push(["TABLE E: Monthly Trend (Historical â€” for Line Chart)"]);
      s2data.push(["Month","Submitted Depts","Avg Achievement","Alerts"]);
      s2data.push(["Oct 2025",25,0.883,3]);
      s2data.push(["Nov 2025",27,0.895,4]);
      s2data.push(["Dec 2025",24,0.871,5]);
      s2data.push(["Jan 2026",26,0.902,3]);
      s2data.push(["Feb 2026",18,0.912,5]);

      const ws2 = XLSX.utils.aoa_to_sheet(s2data);
      ws2['!cols'] = [{wch:30},{wch:16},{wch:14},{wch:16}];

      // Format achievement columns as percentage
      // Find all cells with decimal achievement values and format them
      for (let R = 0; R < s2data.length; R++) {
        for (let C = 0; C < (s2data[R]||[]).length; C++) {
          const v = s2data[R][C];
          if (typeof v === 'number' && v > 0 && v <= 1.3) {
            const addr = XLSX.utils.encode_cell({r:R,c:C});
            if (ws2[addr]) { ws2[addr].z = '0.0%'; }
          }
        }
      }

      XLSX.utils.book_append_sheet(wb, ws2, "Charts Data");

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SHEET 3: INDICATOR DETAIL
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const s3data = [];
      s3data.push(["COMPLETE INDICATOR DATA â€” ALL SUBMITTED DEPARTMENTS â€” FEBRUARY 2026"]);
      s3data.push([]);

      submitted.forEach(([name, cat, , by, inds]) => {
        s3data.push([`${name} â€” ${cat} â€” Submitted by: ${by}`]);
        s3data.push(["#","Indicator","Target","Actual","Achievement %","Status"]);
        inds.forEach((ind, i) => {
          const p = pct(ind[2], ind[1]);
          s3data.push([i+1, ind[0], ind[1], ind[2], p, pctLabel(p)]);
        });
        s3data.push([]);
      });

      const ws3 = XLSX.utils.aoa_to_sheet(s3data);
      ws3['!cols'] = [{wch:4},{wch:38},{wch:12},{wch:12},{wch:14},{wch:14}];

      // Format achievement column (col E = index 4) as percentage
      for (let R = 0; R < s3data.length; R++) {
        const row = s3data[R];
        if (row && row.length >= 5 && typeof row[4] === 'number') {
          const addr = XLSX.utils.encode_cell({r:R, c:4});
          if (ws3[addr]) { ws3[addr].z = '0.0%'; }
        }
      }

      XLSX.utils.book_append_sheet(wb, ws3, "Indicator Detail");

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SHEET 4: ALERTS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const s4data = [
        ["ACTIVE ALERTS & RECOMMENDED ACTIONS â€” FEBRUARY 2026"],
        [],
        ["Department","Indicator","Issue Description","Severity","Recommended Action","Date Identified"],
        ["ICU","Ventilator utilization (%)",
         "Achievement 56% vs 70% target. Only 39% utilization recorded in February.",
         "CRITICAL",
         "Verify data with ICU Chief. Check all ventilator-days are logged. Review records immediately.",
         "Mar 7, 2026"],
        ["CSSD","Monthly report submission",
         "Report deadline was March 5, 2026 â€” now 2 days overdue with no submission.",
         "CRITICAL",
         "Contact CSSD Head immediately. Escalate to Deputy Director if no response by EOD.",
         "Mar 7, 2026"],
        ["Laboratory","TAT routine tests (hours)",
         "Average TAT 8.2 hours vs 6-hour target. Chemistry section most affected.",
         "WARNING",
         "Review lab workflow. Check staffing per shift. Analyze chemistry section bottlenecks.",
         "Mar 7, 2026"],
        ["Maternity","C-section rate (%)",
         "Rate 41.8% vs WHO 30% threshold. Trend requires clinical review.",
         "WARNING",
         "Request obstetric audit. Review surgical indications for February cases. Track monthly.",
         "Mar 7, 2026"],
        ["General Surgery","30-day readmission rate (%)",
         "Rate 18% vs 15% target. Increased from previous month.",
         "WARNING",
         "Review discharge summaries. Strengthen post-discharge follow-up. Identify top diagnoses.",
         "Mar 6, 2026"],
      ];

      const ws4 = XLSX.utils.aoa_to_sheet(s4data);
      ws4['!cols'] = [{wch:20},{wch:26},{wch:46},{wch:12},{wch:46},{wch:14}];
      XLSX.utils.book_append_sheet(wb, ws4, "Alerts & Actions");

      // â”€â”€ DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const month = document.getElementById('hdr-month').textContent || '2026-02';
      const filename = `KCH_Report_${month}.xlsx`;
      XLSX.writeFile(wb, filename);

      btn.textContent = 'âœ“  Downloaded!';
      btn.style.background = '#22C55E';
      setTimeout(() => {
        btn.textContent = 'ğŸ“¥  Export Full Report to Excel';
        btn.style.background = 'linear-gradient(135deg,#00D4AA,#38BDF8)';
        btn.disabled = false;
      }, 3000);

    } catch(err) {
      console.error('Export error:', err);
      btn.textContent = 'âŒ  Export Failed â€” Try Again';
      btn.style.background = '#F43F5E';
      btn.disabled = false;
    }
  }, 100);
}
</script>

</body>
</html>
